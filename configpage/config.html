<!DOCTYPE html>
<html>
	<head>
		<title>CarePortal Pebble Settings</title> 
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />

		<style type='text/css'>
			.hidden {display: none; }
			#divs div { display:none; }
		</style>

		<script src="http://code.jquery.com/jquery-2.1.1.js"></script>
		<script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
		// SHA-1 encryption
		<script src="http://www.movable-type.co.uk/scripts/js/crypto/sha1.js"></script>
		
	        <script>
	            $(document).ready(function() {
	                // hash listener
	                $('#generate-hash').click( function() {
	                    $('#hashAPI').val(Sha1.hash($('#secretAPI').val()));
    	                });
	            });
	        </script>
	</head>
	<body>
		<div data-role="page" id="main">
			 <div data-role="header" class="jqm-header">
				<h2>Pebble CarePortal Settings</h2>
				<tt class="hidden" id="status"></tt>
			</div>

			<div data-role="fieldcontain">
				<fieldset data-role="controlgroup" id="Radio_Options" data-type="horizontal" >
					<legend><strong>Choose mg/dl or mmol:</strong></legend>
					<input name="radio_units" type="radio" id="mgdl_form" onchange="onchange_handler(this, 'mgdl');" onmouseup="onchange_handler(this, 'mgdl');" value="mgdl"/>
					<label for="mgdl_form">mg/dl</label>
					<input type="radio" name="radio_units" id="mmol_form" value="mmol" onchange="onchange_handler(this, 'mmol');" onmouseup="onchange_handler(this, 'mmol');">
					<label for="mmol_form">mmol</label>
				</fieldset>
			</div>
			<div data-role="fieldcontain">
						<legend><strong>Insulin increment:</strong></legend>
				<label for="insulinincrement">Increment for insulin options on watch</label>
				<select  name="insulinincrement" id="insulinincrement">
					<option value="50">0.5</option>
					<option value="1">0.01</option>
					<option value="5">0.05</option>
				</select>
			</div>
			<div data-role="fieldcontain">
				<legend><strong>Enter Data Endpoint:</strong></legend>
				<input type="text" name="endpoint" id="endpoint" autocapitalize="off"
                autocorrect="off"/>
			</div>
			<div>
				ie: https://name.azurewebsites.net/api/v1/treatments/
			</div>
				  
			<div data-role="fieldcontain">
				<legend><strong>Enter Pebble User's Name:</strong></legend>
				<input type="text" name="pebblename" id="pebblename" onfocusout="updateHash(this)"/>
			</div>
			<div>
				ie: The name of the user entering the Care Portal Entries (Dad, Mom, T1 etc.)
			</div>
			<div data-role="fieldcontain">
				<legend><strong>Enter Secret API:</strong></legend>
				<input type="text" name="secretAPI" id="secretAPI" autocapitalize="off"
                autocorrect="off"/>
			</div>
			<div>
				Enter your secret API and Submit will convert it to SHA-1 hash
			</div>
			<div data-role="fieldcontain">
				<legend><strong>Secret API Hash :</strong></legend>
				<input type="text" id="hashAPI" name="hashAPI" id="hashAPI" disabled />
			</div>
			<div>
				Secret API Hash will be automatically generated by clicking the generate button or the submit button.
			</div>

			<div class="ui-body ui-body-b">
				<fieldset class="ui-grid-a">
					<div class="ui-block-a"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></div>
					<div class="ui-block-b"><button type="submit" data-theme="a" id="b-submit">Submit</button></div>
				</fieldset>
			</div>
		</div>
		<script type='text/javascript'>
		
		
			$(window).load(function(){
			if (console && console.log && console.log.call) {
				  } else {
					window.console = { log: function ( ) {
						$('#status').text([ ].slice.call(arguments).join(' '));
					  }
					};
				  }
				  $('#status').text('initializing');
				  function saveOptions() {
					$('#status').text('prepping save');
			                $('#hashAPI').val(Sha1.hash($('#secretAPI').val()));
					var options = {
						'endpoint': $("#endpoint").val(),
						'pebblename' : $("#pebblename").val(),
						'secretAPI' : $("#secretAPI").val(),
						'units' : $('input[name=radio_units]:checked').val(),
						'hashAPI' : $("#hashAPI").val(),
						'insulinincrement' : $("#insulinincrement option:selected").val()						
					}
					// fix for the careportal entry and not being able to put special characters in names
					//if (options.units == 'mgdl')
					//{
					//	options.units = 'mg/dl'
					//}
					try {
					  if (window.localStorage && window.localStorage.setItem) {
						window.localStorage.setItem('cgmOpts', JSON.stringify(options));
					  } else {
						window.localStorage.cgmOpts =  JSON.stringify(options);
					  }
					} catch (e) {
					  console.log('err', e);
					  options.error = e;
					}
					$('#status').text(['prepped', JSON.stringify(options)].join(' '));
					return options;
				  }
				  function loadDefaults() {
					var _raw = null;
					var opts = { };
					_raw = window.localStorage && window.localStorage.cgmOpts
						? window.localStorage.cgmOpts : null;
					opts = (_raw && _raw.length && _raw.length > 5 ? JSON.parse(_raw) : { });
					$("#endpoint").val(opts && opts.endpoint ? opts.endpoint : '');
					$("#pebblename").val(opts && opts.pebblename ? opts.pebblename : '');
					$("input[value='mmol']").attr("checked",false).checkboxradio("refresh");
					$("input[value='mgdl']").attr("checked",true).checkboxradio("refresh");
					$("#secretAPI").val(opts && opts.secretAPI ? opts.secretAPI : '');
					$("#hashAPI").val(opts && opts.hashAPI ? opts.hashAPI : '');
					$("#insulinincrement").val('5').selectmenu("refresh");									
					document.getElementById('mgdl_form').style.display = 'block';
					document.getElementById('mmol_form').style.display = 'none';
				  }
				  
				  function getOptions() {
					$('#status').text('fetching from localStorage');
					var _raw = null;
					var opts = { };
					
					if(window.localStorage.cgmOpts){
						_raw = window.localStorage && window.localStorage.cgmOpts
							? window.localStorage.cgmOpts : null;
						opts = (_raw && _raw.length && _raw.length > 5 ? JSON.parse(_raw) : { });
						$('#status').text(['has opts', JSON.stringify(opts)].join(' '));
						console.log("opts", JSON.stringify(opts));
						$("#endpoint").val(opts && opts.endpoint ? opts.endpoint : '');
						$("#pebblename").val(opts && opts.pebblename ? opts.pebblename : '');
						$("#secretAPI").val(opts && opts.secretAPI ? opts.secretAPI : '');
						$("#hashAPI").val(opts && opts.hashAPI ? opts.hashAPI : '');
						$("#insulinincrement").val(opts.insulinincrement).selectmenu("refresh");
						if (opts.units == 'mgdl_form'){
							$("input[value='" + opts.units + "']").attr("checked",true).checkboxradio("refresh");
							document.getElementById('mgdl_form').style.display = 'block';
							document.getElementById('mmol_form').style.display = 'none';
						} else {
							$("input[value='mgdl']").attr("checked",false).checkboxradio("refresh");
							document.getElementById('mmol_form').style.display = 'block';
							document.getElementById('mgdl_form').style.display = 'none';
							$("input[value='" + opts.units + "']").attr("checked",true).checkboxradio("refresh");
						}
					}else{
						console.log("no data");
						$('#status').text('no data');
						loadDefaults();
					}
					
				}
				  $().ready(function() {
					if (window.location.hash.indexOf("debug") > -1) {
					  $('#status').removeClass('hidden');
					}
					$('#status').text('ready');
					$('#status').text('setting up events');
					//localStorage.clear();
					
					$("#b-cancel").click(function() {
					  console.log("Cancel");
					  $('#status').text('canceling');
					  document.location = "pebblejs://close";
					});
					$("#b-submit").click(function() {
					  console.log("Submit");
					  $('#status').text('submitting');
					  var location = "pebblejs://close#" + encodeURIComponent(JSON.stringify(saveOptions()));
					  console.log("Warping to: " + location);
					  $('#status').text('closing');
					  document.location = location;
					  // console.log('saved', window.localStorage.cgmOpts);
					});
					
					$("#b-default").click(function() {
						console.log("Default");
						localStorage.clear();
						loadDefaults();
					});
				  });
				  $('#main').bind('pageinit', getOptions());
			});
			function onchange_handler(obj, id) {
				var other_id = (id == 'mgdl')? 'mmol' : 'mgdl';
				if(obj.checked) {
					document.getElementById(id + '_form').style.display = 'block';
					document.getElementById(other_id + '_form').style.display = 'none';
				} else {
					document.getElementById(id + '_form').style.display = 'none';
					document.getElementById(other_id + '_form').style.display = 'block';
				}
			}
		</script>
	</body>
</html>